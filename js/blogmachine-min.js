/* (c) 2013 JN - github.com/jnu/blogmachine */
function BlogMachine(b){if(BlogMachine.prototype.__instance__){return BlogMachine.prototype.__instance__}var a=this;BlogMachine.prototype.__instance__=a;this.cache={};this.vars={dbHost:"/db",dbName:"joenoodles",dbDesignDoc:"views",blogConfigDoc:"config",indexView:"index",spriteMap:"spriteMap"};this.__configLoaded__=false;this.__metaLoaded__=false;a.queryDB(this.vars.blogConfigDoc,function(d){$.extend(true,a.vars,d);if(typeof b==="object"){$.extend(true,a.vars,b)}a.__configLoaded__=true;a.init()});a.queryDB(a.vars.spriteMap,function(d){a.cache.spriteMap=d;a.__metaLoaded__=true;a.init()})}BlogMachine.prototype.init=function(){var a=this;if(!(this.__configLoaded__&&this.__metaLoaded__)){return false}this.Models={};this.Collections={};this.Views={};this.Routers={};this.Models.Page=Backbone.Model.extend({sync:function(e,d,b){if(d.id===null){b.error("Need to pass ID to fetch; got null.");return false}switch(e){case"update":b.success(d.attributes);break;case"read":a.queryDB(d.id,d.attributes.force||false,function(f){b.success(f);d.trigger("loaded")});break;default:b.error("Illegal operation on model.sync: "+d);return false}},initialize:function(b){}});this.Collections.Pages=Backbone.Collection.extend({model:a.Models.Page,url:a.vars.dbName,dbView:"index",_firstLoaded:false,sync:function(e,d,b){if(e!="read"){b.error("Illegal operation on collection.sync "+e);return false}a.viewDB(d.dbView,function(f){b.success(f.rows.map(function(j){var h=j.value,i=new Date(h.created),g=(h.category||"").split(">");$.extend(h,{id:j.id,cleanTitle:wp_cleanPostTitle(h.title),date:new Date(h.created||0),categories:g,cleanCategories:g.map(wp_cleanPostTitle),template:"post"});return h}));if(!d._firstLoaded){a.router=new a.Routers.Router;d._firstLoaded=true}})}});this.Views.BlogView=Backbone.View.extend({el:"body",pEl:"#page-cont",$pEl:undefined,childViews:{},initialize:function(b){this.childViews.header=new a.Views.Header;this.childViews.footer=new a.Views.Footer;this.childViews.page=null;this.renderStatic();this.$pEl=$(this.pEl);_.bindAll(this,"render")},setPageView:function(b){var e=this,d=this.childViews.page;this.childViews.page=b;this.listenToOnce(this.childViews.page,"rendered",function(){if(d){d.$el.fadeOut("fast",function(){e.render();d.remove()})}else{e.render()}})},renderStatic:function(){this.childViews.header.render();this.childViews.footer.render();var b=a.render("main",{});this.$el.html(b);$("#header-cont").html(this.childViews.header.el);$("#footer-cont").html(this.childViews.footer.el);return this},render:function(){this.childViews.page.$el.hide();this.$pEl.html(this.childViews.page.el);this.childViews.page.$el.fadeIn("slow");$.scrollTo(this.pEl,800);return this}});this.Views.Header=Backbone.View.extend({id:a.vars.headerEl,className:"page-header text-center",events:{click:"goHome"},goHome:function(){a.router.navigate("/",{trigger:true})},render:function(){var b=a.render("banner",{banner:{img:a.vars.banner,alt:a.vars.bannerAlt}});this.$el.html(b);return this}});this.Views.Footer=Backbone.View.extend({id:a.vars.footerEl,className:"row-fluid text-center footer",render:function(){var b=a.render("footer",{copyright:a.vars.copyright,navLinks:a.vars.navLinks,badges:a.vars.badges,footer:{img:a.vars.footer,alt:a.vars.footerAlt}});this.$el.html(b);return this}});this.Views.Social=Backbone.View.extend({tagName:"div",id:"social-links",sites:["facebook","twitter","googleplus","tumblr","reddit"],_networks:{facebook:{url:"//www.facebook.com/sharer/sharer.php?u={url}&t={text}"},twitter:{url:"//twitter.com/intent/tweet?text={text}&url={url}"},tumblr:{url:"//www.tumblr.com/share?v=3&u={url}&t={text}&s="},googleplus:{url:"//plus.google.com/share?url={url}"},reddit:{url:"//www.reddit.com/submit?url={url}"}},initialize:function(b){var d=this;_.bindAll(this,"render");if((b||{}).sites){this.sites=b.sites}this.render()},render:function(){var e=this,b="",d=encodeURIComponent(window.location),f=encodeURIComponent(document.title);_.forEach(this.sites,function(g){var h=e._networks[g],i=h.url.replace("{url}",d).replace("{text}",f);b+='<a href="'+i+'" class="social '+g+'" target="_blank"></a>'});this.$el.html(b);return this}});this.Views.Page=Backbone.View.extend({tagName:"div",id:a.vars.contentEl,children:[],initialize:function(b){var d=this;_.bindAll(this,"render");this.listenTo(this.model,"loaded",this.render)},render:function(){var d=a.render(this.model.get("template"),this.model.toJSON());this.$el.html(d);var b=new a.Views.Social;this.children.push(b.render());this.$el.append("<div class='row-fluid text-center'><div class='span4 offset4' id='social-cont'></div></div>");this.$el.find("#social-cont").html(b.el);this.trigger("rendered");return this},remove:function(){Backbone.View.prototype.remove.apply(this,arguments);_.each(this.children,function(b){b.remove()})}});this.Views.Home=Backbone.View.extend({tagName:"div",id:a.vars.homeEl,categories:[],initialize:function(b){_.bindAll(this,"render");this.categories=b.categories||[];this.children=[]},render:function(){var b=(new a.Views.Index({collection:this.collection})).render();this.children.push(b);var d=a.render("home",{latest:this.collection.sortBy(function(e){return e.get("date").valueOf()}).reverse().slice(0,2).map(function(e){e.set("link",a.createWPPermalink(e,"post"));return e}),categories:this.categories});this.$el.html(d);this.$el.find("#index-cont").html(b.el);this.trigger("rendered");return this},remove:function(){Backbone.View.prototype.remove.apply(this,arguments);_.each(this.children,function(b){b.remove()})}});this.Views.Index=Backbone.View.extend({tagName:"div",id:a.vars.contentEl,initialize:function(b){var d=this;_.bindAll(this,"render");this.children=[]},render:function(){var i=this,e=this.collection.sortBy(function(j){return j.get("category")}),g=[],f=[],d=0,h=new indexNumberFormatter(),b=function(k){while(f.length<=k){f.push(0)}for(var j=k+1;j<f.length;j++){f[j]=0}f[k]++;return f};_.forEach(e,function(q,l){var p=(q.get("cleanCategories")||[]),s=(q.get("categories")||[]),n=null,k=0,u="";if(q.get("type")=="page"){b(k);var o="Appendix "+String.fromCharCode(64+(++d)),t=new a.Views.IndexLine({properties:{model:q,numId:""+l+k+l,fNum:h(f,k),hDepth:k+3,link:"/"+(q.id),title:o+"&mdash;"+q.get("title"),sprite:q.get("sprite")}});i.children.push(t);i.$el.append(t.render().el);return}for(k=0;k<s.length;k++){if(s[k]!=g[k]){u+="/"+p[k];b(k);var r=new a.Views.IndexLine({properties:{model:q,numId:""+(k+1)+l,fNum:h(f,k),hDepth:k+3,link:"/category"+u,title:s[k],sprite:""}});i.children.push(r);i.$el.append(r.render().el)}}g=s;b(k);var m=new a.Views.IndexLine({properties:{model:q,numId:l,fNum:h(f,k),hDepth:s.length+3,link:a.createWPPermalink(q,"post"),date:q.get("date"),title:q.get("title"),sprite:q.get("sprite")}});i.children.push(m);i.$el.append(m.render().el)});return this},remove:function(){Backbone.View.prototype.remove.apply(this,arguments);_.each(this.children,function(b){b.remove()})}});this.Views.IndexLine=Backbone.View.extend({tagName:"div",className:"indexline",properties:{},initialize:function(b){_.bindAll(this,"render");this.properties=b.properties},render:function(){var b=a.render("indexline",this.properties);this.$el.html(b);return this}});this.Routers.Router=Backbone.Router.extend({initialize:function(b){var d=this,e=[["*page","getPostByID"],[/([0-9]{4})\/([0-9]{1,2})\/(.*)/,"wpRoute"],["posts/:id","getPostByID"],["category/*category","listCategory"],["","getHomePage"]];_.each(e,function(f){d.route.apply(d,f)});this.model=b?b.model:{};Backbone.history.start({pushState:true});interceptClicks.call(this)},getHomePage:function(){var b=(new a.Views.Home({collection:a.pages}));a.blogview.setPageView(b);b.render()},getPostByID:function(d){var b=a.pages.get(d);a.blogview.setPageView(new a.Views.Page({model:b}));b.fetch()},listCategory:function(d){d=d.replace(/^\/+/,"").replace(/\/+$/,"");var g=a.pages.filter(function(h){return h.get("cleanCategories").join("/")==d});c=new Backbone.Collection(g),cats=[];if(g.length){var b=g[0].get("cleanCategories"),f=g[0].get("categories");_.forEach(b,function(j,h){cats.push({clean:b[h],name:f[h]})})}var e=(new a.Views.Home({collection:c,categories:cats}));a.blogview.setPageView(e);e.render()},wpRoute:function(d,e,f){d=parseInt(d),e=parseInt(e),f=f.replace(/\/$/,"");var b=a.pages.filter(function(g){return g.get("date").getFullYear()==d&&(g.get("date").getMonth()+1)==e&&(g.get("cleanTitle")==f||g.get("oldUrl")==f)});if(b.length){return this.getPostByID(b[0].id)}else{return this.getHomePage()}}});this.blogview=new this.Views.BlogView;this.pages=new this.Collections.Pages;this.pages.fetch()};BlogMachine.prototype.render=function(d,a){if(!this.cache.templates){this.cache.templates={}}if(!this.cache.templates[d]){var b;$.ajax({url:this.vars.tplDir+"/"+d+"-tpl.html",method:"GET",async:false,dataType:"html",success:function(e){b=_.template(e)}});this.cache.templates[d]=b}return this.cache.templates[d](a)};BlogMachine.prototype.queryDB=function(e,d,f){var b=this,a=this.vars.dbHost+"/"+this.vars.dbName+"/"+e;if(typeof d==="function"){f=d}if(!this.cache.db){this.cache.db={}}if(!this.cache.db[e]||d===true){$.ajax({url:a,method:"GET",async:true,dataType:"json",success:function(g){b.cache.db[e]=g;if(f){f(g)}}})}else{if(f){f(this.cache.db[e])}}};BlogMachine.prototype.viewDB=function(a,d,e){var b="_design/"+this.vars.dbDesignDoc+"/_view/"+a;this.queryDB(b,d,e)};BlogMachine.prototype.createWPPermalink=function(a,b){var d="/";if(b==="post"){d+=a.get("date").getFullYear()+"/"+(a.get("date").getMonth()+1)+"/"+a.get("cleanTitle")}else{if(a.type==="category"){if((a.cleanCategories||[]).length){d+="category/"+a.cleanCategories.join("/")+"/"}}}return d};function indexNumberFormatter(){var b=this,d=["M","CM","D","CD","C","XC","L","XL","X","IX","V","IV","I"],a=[1000,900,500,400,100,90,50,40,10,9,5,4,1];this.formats={abc:function(e){if(e>26||e<1){throw new Error(e+" is out of format range.")}return String.fromCharCode(96+e)},ABC:function(e){return b.formats.abc(e).toUpperCase()},romnum:function(e){return b.formats.ROMNUM(e).toLowerCase()},ROMNUM:function(g){if(g<1||g>=4000){throw new Error(g+" is out of format range.")}var f="";for(var e=0;e<d.length;e++){while(g>=a[e]){g-=a[e];f+=d[e]}}return f},dotSub:function(g,f,e){if(f<1){throw new Error("Can't dot-sub first level")}return e[f-1]+"."+g}};this.tiers=[this.formats.ROMNUM,this.formats.dotSub,this.formats.ABC,this.formats.romnum,this.formats.abc];this.format=function(e,f){return b.tiers[f](e[f],f,e)};return this.format}function interceptClicks(){var a=this;function b(k,f){function h(e){k.preventDefault();var i=e.replace(/^\//,"").replace("#!/","");a.navigate(i,{trigger:true})}var d=f?window.location.path:$(k.currentTarget).attr("href"),l=false,j=[/^\/\/[\w]/,/^\/static\//,/^\/sandbox\//];for(var g=0;g<j.length;g++){l=j[g].test(d);if(l){break}}if(!l&&!k.altKey&&!k.ctrlKey&&!k.MetaKey&&!k.shiftKey){$.scrollTo(0,{duration:300,onAfter:function(){h(d||"")}});return false}return true}$(document).on("click","a[href^='/']",b);window.addEventListener("popstate",function(d){})}function wp_cleanPostTitle(a){return a.toLowerCase().replace(/<.*?>/g,"").replace(/[^\w\d\s]/g,"").replace(/\s+/g,"-")}function encode(b,a){if(a===undefined){a=1}var f="",h=b.length,g=0;for(var d=0;d<b.length;d++){x=-(a-d+h);g=b.charCodeAt(d)-x;while(g<0){g+=256}g%=256;f+=String.fromCharCode(g)}return f}function decode(b,a){if(a===undefined){a=1}var f="",h=b.length,g=0;for(var e=0;e<b.length;e++){x=-(a-e+h);g=b.charCodeAt(e)+x;g%=256;f+=String.fromCharCode(g)}return f}function clone(b,a){return $.extend(a===false?false:true,{},b)}function Error(a){this.msg=a};